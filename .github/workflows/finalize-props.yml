name: finalize-props

on:
  # run manually from the Actions tab
  workflow_dispatch:
  # run automatically every Tuesday 11:00 UTC ≈ 7:00 AM ET (cron is UTC)
  schedule:
    - cron: "0 11 * * TUE"

permissions:
  contents: write

concurrency:
  group: finalize-props-${{ github.ref }}
  cancel-in-progress: false

env:
  PYTHONUTF8: "1"
  TZ: "UTC"

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install -U pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Show inputs (if present)
        run: |
          ls -lh data/props 2>/dev/null || true
          ls -lh data/weekly 2>/dev/null || true
          sed -n '1,20p' data/props/history_pending.csv 2>/dev/null || true
          sed -n '1,20p' data/weekly/latest.csv 2>/dev/null || true

      - name: Finalize props → stamp outcomes (only if both inputs exist)
        id: finalize
        run: |
          set -e
          OUT="data/props/history_props_with_outcomes.csv"
          PENDING="data/props/history_pending.csv"
          WEEKLY="data/weekly/latest.csv"

          if [ ! -f "$PENDING" ]; then
            echo "No $PENDING; nothing pending to finalize."
            echo "wrote_outcomes=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          if [ ! -f "$WEEKLY" ]; then
            echo "No $WEEKLY (weekly stats). Keeping pending; skipping finalize."
            echo "wrote_outcomes=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          if [ ! -f scripts/08_finalize_props_outcomes.py ]; then
            echo "scripts/08_finalize_props_outcomes.py not found; skipping."
            echo "wrote_outcomes=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          python scripts/08_finalize_props_outcomes.py \
            --pending "$PENDING" \
            --weekly  "$WEEKLY" \
            --out     "$OUT" \
            --join    player_week

          if [ -f "$OUT" ]; then
            echo "Wrote $OUT"
            echo "wrote_outcomes=true" >> $GITHUB_OUTPUT
          else
            echo "Finalize script ran but $OUT not found; skipping cleanup."
            echo "wrote_outcomes=false" >> $GITHUB_OUTPUT
          fi

      - name: Show outputs
        run: |
          sed -n '1,25p' data/props/history_props_with_outcomes.csv 2>/dev/null || true
          ls -lh data/props || true

      - name: Commit finalized history (only if outcomes were written)
        if: steps.finalize.outputs.wrote_outcomes == 'true'
        run: |
          set -e
          git config user.name  "github-actions"
          git config user.email "github-actions@users.noreply.github.com"
          git add data/props/history_props_with_outcomes.csv || true
          # Remove pending only when outcomes exist
          git rm -f data/props/history_pending.csv 2>/dev/null || true
          if ! git diff --cached --quiet; then
            git commit -m "Finalize props outcomes: update history_props_with_outcomes.csv (run ${{ github.run_id }})"
            git push
          else
            echo "No changes to commit."
          fi

      - name: Upload finalized history (artifact, 90-day retention)
        if: steps.finalize.outputs.wrote_outcomes == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: history-props-with-outcomes-${{ github.run_id }}
          path: data/props/history_props_with_outcomes.csv
          if-no-files-found: warn
          retention-days: 90
